<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Idea Spinner</title>
  <style>
    /* === WF Design Studio — Velvet Teal === */
    :root {
      --primary-700: #112627;
      --primary-500: #224749;
      --primary-400: #2B5759;
      --primary-300: #356769;
      --primary-100: #BBC8C9;
      --secondary: #8E9370;
      --accent-1: #A67C52;
      --accent-2: #8B504C;
      --olive-deep: #6E744F;
      --paper: #FAF4DD;
      --stone: #EEE8D2;
      --ink: #282413;
      --hover-teal: #193638;
      --active-teal: #112627;
      --olive-hover: #5d6343;
      --olive-active: #4d5336;
      --accent-1-hover: #b8894a;
      --accent-2-hover: #7a4542;
      --accent-2-active: #6a3a38;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
      background-color: var(--primary-500);
      color: var(--paper);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }

    /* === Shared === */
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      max-width: 600px;
      width: 100%;
    }

    .screen.active {
      display: flex;
    }

    h1 {
      font-size: clamp(3rem, 10vw, 5rem);
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.1;
      color: #fff;
    }

    .tagline {
      font-size: clamp(1.1rem, 3vw, 1.4rem);
      font-weight: 400;
      color: var(--paper);
      opacity: 0.9;
      line-height: 1.5;
      max-width: 28ch;
    }

    /* === Buttons === */
    .btn {
      padding: 1.2rem 3.5rem;
      font-size: clamp(1.3rem, 4vw, 1.6rem);
      font-weight: 700;
      color: #fff;
      background-color: var(--olive-deep);
      border: none;
      border-radius: 60px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.15s ease;
    }

    .btn:hover {
      background-color: var(--olive-hover);
      transform: scale(1.04);
    }

    .btn:active {
      background-color: var(--olive-active);
      transform: scale(0.98);
    }

    .btn:focus-visible {
      outline: 3px solid var(--paper);
      outline-offset: 4px;
    }

    .btn.pulse {
      animation: pulse 2.5s ease-in-out infinite;
    }

    .btn-secondary {
      padding: 0.9rem 2.5rem;
      font-size: clamp(1rem, 3vw, 1.2rem);
      font-weight: 600;
      color: var(--paper);
      background: transparent;
      border: 2px solid var(--paper);
      border-radius: 60px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.15s ease;
    }

    .btn-secondary:hover {
      background-color: rgba(250, 244, 221, 0.1);
      transform: scale(1.04);
    }

    .btn-secondary:active {
      background-color: rgba(250, 244, 221, 0.15);
      transform: scale(0.98);
    }

    .btn-secondary:focus-visible {
      outline: 3px solid var(--paper);
      outline-offset: 4px;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(110, 116, 79, 0.5); }
      50% { box-shadow: 0 0 0 14px rgba(110, 116, 79, 0); }
    }

    /* === Step Progress Dots === */
    .step-dots {
      display: flex;
      gap: 0.6rem;
      margin-bottom: 0.5rem;
    }

    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--primary-300);
      transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .step-dot.filled {
      background-color: var(--accent-1);
      transform: scale(1.15);
    }

    .step-dot.current {
      background-color: var(--paper);
      transform: scale(1.25);
    }

    /* === Prompt area (shared) === */
    .step-label {
      font-size: clamp(0.95rem, 2.5vw, 1.1rem);
      font-weight: 500;
      color: var(--primary-100);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .prompt-box {
      min-height: 7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .prompt-text {
      font-size: clamp(1.6rem, 5vw, 2.4rem);
      font-weight: 700;
      color: #fff;
      line-height: 1.3;
      max-width: 22ch;
    }

    .shuffle-btn {
      background: none;
      border: none;
      color: var(--primary-100);
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      transition: color 0.2s ease, background-color 0.2s ease;
    }

    .shuffle-btn:hover {
      color: var(--paper);
      background-color: rgba(250, 244, 221, 0.08);
    }

    .shuffle-btn:focus-visible {
      outline: 2px solid var(--primary-100);
      outline-offset: 2px;
    }

    /* === Inputs === */
    .name-input {
      width: 100%;
      max-width: 400px;
      padding: 1rem 1.5rem;
      font-size: clamp(1.2rem, 4vw, 1.5rem);
      font-family: inherit;
      font-weight: 600;
      text-align: center;
      color: var(--ink);
      background-color: var(--paper);
      border: 3px solid transparent;
      border-radius: 16px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .name-input::placeholder {
      color: var(--secondary);
      font-weight: 400;
    }

    .name-input:focus {
      border-color: var(--accent-1);
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      align-items: center;
      margin-top: 0.5rem;
    }

    /* === Name Chips === */
    .name-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      min-height: 2rem;
    }

    .name-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.9rem;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--ink);
      background-color: var(--primary-100);
      border-radius: 40px;
    }

    .name-chip-remove {
      background: none;
      border: none;
      color: var(--primary-400);
      font-size: 1.1rem;
      line-height: 1;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
    }

    .name-chip-remove:hover {
      color: var(--accent-2);
    }

    /* === Spinner Screen === */
    .spinner-prompt-box {
      min-height: 9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 1rem;
    }

    .spinner-prompt {
      font-size: clamp(1.5rem, 4.5vw, 2.2rem);
      font-weight: 700;
      color: #fff;
      line-height: 1.5;
      max-width: 26ch;
    }

    .name-variable {
      display: inline-block;
      background-color: var(--accent-1);
      color: var(--ink);
      padding: 0.05em 0.45em;
      border-radius: 8px;
      border: 2px dashed var(--paper);
      font-weight: 800;
    }

    .spinner-answer {
      width: 100%;
      max-width: 460px;
      min-height: 70px;
      padding: 0.8rem 1rem;
      font-size: clamp(1rem, 3vw, 1.15rem);
      font-family: inherit;
      font-weight: 500;
      color: var(--ink);
      background-color: var(--paper);
      border: 3px solid transparent;
      border-radius: 14px;
      outline: none;
      resize: vertical;
      transition: border-color 0.2s ease;
    }

    .spinner-answer::placeholder {
      color: var(--secondary);
      font-weight: 400;
    }

    .spinner-answer:focus {
      border-color: var(--accent-1);
    }

    .spin-btn {
      padding: 0.8rem 2rem;
      font-size: clamp(1.1rem, 3vw, 1.3rem);
      font-weight: 700;
      color: #fff;
      background-color: var(--accent-2);
      border: none;
      border-radius: 60px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.15s ease;
    }

    .spin-btn:hover {
      background-color: var(--accent-2-hover);
      transform: scale(1.04);
    }

    .spin-btn:active {
      background-color: var(--accent-2-active);
      transform: scale(0.98);
    }

    .spin-btn:focus-visible {
      outline: 3px solid var(--paper);
      outline-offset: 4px;
    }

    /* === Proposal Screen === */
    .proposal-banner {
      font-size: clamp(1.1rem, 3vw, 1.3rem);
      font-weight: 600;
      color: var(--ink);
      background-color: var(--accent-1);
      padding: 0.6rem 1.5rem;
      border-radius: 40px;
    }

    .proposal-banner .name-variable {
      border-color: var(--ink);
    }

    .inspiration-card {
      width: 100%;
      background-color: var(--primary-400);
      border-radius: 14px;
      padding: 1rem 1.2rem;
      text-align: left;
    }

    .inspiration-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent-1);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.4rem;
    }

    .inspiration-prompt {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--primary-100);
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .inspiration-answer {
      font-size: 1.05rem;
      font-weight: 500;
      color: var(--paper);
      line-height: 1.4;
      font-style: italic;
    }

    .proposal-form {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .field-group {
      text-align: left;
    }

    .field-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary-100);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.4rem;
    }

    .field-input {
      width: 100%;
      padding: 0.8rem 1rem;
      font-size: clamp(1rem, 3vw, 1.15rem);
      font-family: inherit;
      font-weight: 500;
      color: var(--ink);
      background-color: var(--paper);
      border: 3px solid transparent;
      border-radius: 12px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .field-input:focus {
      border-color: var(--accent-1);
    }

    textarea.field-input {
      min-height: 80px;
      resize: vertical;
    }

    .field-input::placeholder {
      color: var(--secondary);
      font-weight: 400;
    }

    /* === Start Over link === */
    .start-over {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: none;
      border: none;
      color: var(--primary-100);
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      opacity: 0.6;
      transition: opacity 0.2s ease, color 0.2s ease;
      display: none;
    }

    .start-over:hover {
      opacity: 1;
      color: var(--paper);
    }

    .start-over.visible {
      display: block;
    }

    /* === Thank You Screen === */
    .thankyou-title {
      font-size: clamp(2rem, 7vw, 3.5rem);
      font-weight: 800;
      color: #fff;
      line-height: 1.1;
    }

    .thankyou-subtitle {
      font-size: clamp(1.1rem, 3vw, 1.3rem);
      font-weight: 500;
      color: var(--paper);
      opacity: 0.9;
      max-width: 28ch;
      line-height: 1.5;
    }

    .proposal-count-badge {
      display: inline-block;
      background-color: var(--accent-1);
      color: var(--ink);
      font-weight: 700;
      font-size: 1rem;
      padding: 0.4rem 1.2rem;
      border-radius: 40px;
    }

    /* === Fade transitions === */
    .fade-in {
      animation: fadeIn 0.35s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .prompt-fade {
      animation: fadeIn 0.25s ease-out;
    }

    /* === Proposal Indicator (floating pill) === */
    .proposal-indicator {
      position: fixed;
      top: 1rem;
      right: 1rem;
      display: none;
      align-items: center;
      gap: 0.4rem;
      background-color: var(--accent-1);
      color: var(--ink);
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 700;
      padding: 0.4rem 0.9rem;
      border: none;
      border-radius: 40px;
      cursor: pointer;
      transition: transform 0.15s ease, background-color 0.2s ease;
      z-index: 10;
    }

    .proposal-indicator.visible {
      display: flex;
    }

    .proposal-indicator:hover {
      background-color: var(--accent-1-hover);
      transform: scale(1.06);
    }

    .proposal-indicator:focus-visible {
      outline: 3px solid var(--paper);
      outline-offset: 4px;
    }

    /* === Review Screen === */
    .review-header {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .review-title {
      font-size: clamp(2rem, 7vw, 3rem);
      font-weight: 800;
      color: #fff;
    }

    .review-count {
      display: inline-block;
      background-color: var(--accent-1);
      color: var(--ink);
      font-weight: 700;
      font-size: 1rem;
      padding: 0.3rem 0.9rem;
      border-radius: 40px;
    }

    .review-list {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 0.25rem;
    }

    .review-card {
      width: 100%;
      background-color: var(--primary-400);
      border-radius: 14px;
      padding: 1rem 1.2rem;
      text-align: left;
    }

    .review-card-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 0.4rem;
    }

    .review-card-name {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--primary-100);
      margin-bottom: 0.5rem;
    }

    .review-card-detail {
      font-size: 0.9rem;
      color: var(--paper);
      line-height: 1.4;
      margin-bottom: 0.35rem;
    }

    .review-card-detail-label {
      font-weight: 600;
      color: var(--accent-1);
    }

    .back-btn {
      background: none;
      border: none;
      color: var(--primary-100);
      font-family: inherit;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      transition: color 0.2s ease;
    }

    .back-btn:hover {
      color: var(--paper);
    }

    .back-btn:focus-visible {
      outline: 2px solid var(--paper);
      outline-offset: 2px;
    }

    /* === Review Card Checkbox === */
    .review-card-wrap {
      display: flex;
      align-items: flex-start;
      gap: 0.7rem;
      width: 100%;
    }

    .review-card-check {
      flex-shrink: 0;
      width: 22px;
      height: 22px;
      margin-top: 1rem;
      accent-color: var(--accent-1);
      cursor: pointer;
    }

    .review-card-wrap .review-card {
      flex: 1;
      min-width: 0;
    }

    /* === Select All / Deselect All === */
    .select-all-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      width: 100%;
      font-size: 0.9rem;
      color: var(--primary-100);
    }

    .select-all-row label {
      cursor: pointer;
      font-weight: 600;
      user-select: none;
    }

    .select-all-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-1);
      cursor: pointer;
    }

    /* === Email Recipient Field === */
    .email-row {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .email-row label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary-100);
      white-space: nowrap;
    }

    .email-input {
      flex: 1;
      padding: 0.5rem 0.8rem;
      font-size: 0.95rem;
      font-family: inherit;
      color: var(--ink);
      background-color: var(--paper);
      border: 2px solid transparent;
      border-radius: 10px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .email-input:focus {
      border-color: var(--accent-1);
    }

    .email-input::placeholder {
      color: var(--secondary);
    }

    /* === Export Toolbar === */
    .export-toolbar {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      padding: 0.8rem 0;
    }

    .export-btn {
      padding: 0.55rem 1.1rem;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: inherit;
      color: var(--paper);
      background-color: var(--primary-300);
      border: none;
      border-radius: 40px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.15s ease, opacity 0.2s ease;
    }

    .export-btn:hover:not(:disabled) {
      background-color: var(--accent-1);
      color: var(--ink);
      transform: scale(1.04);
    }

    .export-btn:active:not(:disabled) {
      transform: scale(0.97);
    }

    .export-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .export-btn:focus-visible {
      outline: 2px solid var(--paper);
      outline-offset: 2px;
    }

    /* === Toast Notification === */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background-color: var(--olive-deep);
      color: #fff;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      padding: 0.6rem 1.5rem;
      border-radius: 40px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 100;
    }

    .toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* === Settings === */
    .settings-btn {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: none;
      border: none;
      color: var(--primary-100);
      font-size: 1.4rem;
      cursor: pointer;
      padding: 0.3rem;
      border-radius: 6px;
      opacity: 0.6;
      transition: opacity 0.2s ease, color 0.2s ease;
      display: none;
      z-index: 10;
    }

    .settings-btn:hover {
      opacity: 1;
      color: var(--paper);
    }

    .settings-btn:focus-visible {
      outline: 2px solid var(--paper);
      outline-offset: 2px;
    }

    .settings-btn.visible {
      display: block;
    }

    .settings-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 1rem;
    }

    .settings-overlay.visible {
      display: flex;
    }

    .settings-panel {
      background-color: var(--primary-400);
      border-radius: 16px;
      padding: 1.5rem;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .settings-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #fff;
    }

    .settings-field {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      text-align: left;
    }

    .settings-field label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary-100);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .settings-field input {
      width: 100%;
      padding: 0.7rem 1rem;
      font-size: 1rem;
      font-family: inherit;
      font-weight: 500;
      color: var(--ink);
      background-color: var(--paper);
      border: 2px solid transparent;
      border-radius: 10px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .settings-field input:focus {
      border-color: var(--accent-1);
    }

    .settings-field input::placeholder {
      color: var(--secondary);
      font-weight: 400;
    }

    .settings-done-btn {
      padding: 0.8rem 2rem;
      font-size: 1.1rem;
      font-weight: 700;
      font-family: inherit;
      color: #fff;
      background-color: var(--olive-deep);
      border: none;
      border-radius: 60px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.15s ease;
      align-self: center;
    }

    .settings-done-btn:hover {
      background-color: var(--olive-hover);
      transform: scale(1.04);
    }

    .settings-done-btn:active {
      background-color: var(--olive-active);
      transform: scale(0.98);
    }

    .settings-done-btn:focus-visible {
      outline: 3px solid var(--paper);
      outline-offset: 4px;
    }

    /* === Settings: Prompt Editor === */
    .settings-section-title {
      font-size: 1rem;
      font-weight: 700;
      color: #fff;
      margin-top: 0.5rem;
    }

    .settings-helper {
      font-size: 0.8rem;
      color: var(--primary-100);
      opacity: 0.8;
      text-align: left;
      line-height: 1.4;
    }

    .settings-prompt-list {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .settings-prompt-row {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }

    .settings-prompt-input {
      flex: 1;
      padding: 0.5rem 0.7rem;
      font-size: 0.85rem;
      font-family: inherit;
      font-weight: 500;
      color: var(--ink);
      background-color: var(--paper);
      border: 2px solid transparent;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .settings-prompt-input:focus {
      border-color: var(--accent-1);
    }

    .settings-prompt-delete {
      background: none;
      border: none;
      color: var(--primary-100);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.2rem 0.4rem;
      line-height: 1;
      border-radius: 4px;
      opacity: 0.6;
      transition: opacity 0.2s ease, color 0.2s ease;
    }

    .settings-prompt-delete:hover {
      opacity: 1;
      color: var(--accent-2);
    }

    .settings-add-btn {
      background: none;
      border: 1px dashed var(--primary-100);
      color: var(--primary-100);
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      transition: color 0.2s ease, border-color 0.2s ease;
      align-self: flex-start;
    }

    .settings-add-btn:hover {
      color: var(--paper);
      border-color: var(--paper);
    }

    .settings-reset-btn {
      background: none;
      border: none;
      color: var(--primary-100);
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0.2rem 0;
      opacity: 0.7;
      transition: opacity 0.2s ease;
      align-self: flex-start;
    }

    .settings-reset-btn:hover {
      opacity: 1;
      text-decoration: underline;
    }

    /* === Settings: Theme === */
    .settings-color-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-align: left;
    }

    .settings-color-label {
      flex: 1;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary-100);
    }

    .settings-color-swatch {
      width: 32px;
      height: 32px;
      padding: 0;
      border: 2px solid var(--primary-100);
      border-radius: 6px;
      cursor: pointer;
      background: none;
    }

    .settings-color-swatch::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .settings-color-swatch::-webkit-color-swatch {
      border: none;
      border-radius: 4px;
    }

    .settings-color-swatch::-moz-color-swatch {
      border: none;
      border-radius: 4px;
    }

    .settings-color-hex {
      width: 5.5rem;
      padding: 0.35rem 0.5rem;
      font-size: 0.8rem;
      font-family: monospace;
      color: var(--ink);
      background-color: var(--paper);
      border: 2px solid transparent;
      border-radius: 6px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .settings-color-hex:focus {
      border-color: var(--accent-1);
    }

    .settings-preset-row {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }

    .settings-preset-name {
      flex: 1;
      padding: 0.4rem 0.7rem;
      font-size: 0.85rem;
      font-family: inherit;
      color: var(--ink);
      background-color: var(--paper);
      border: 2px solid transparent;
      border-radius: 8px;
      outline: none;
    }

    .settings-preset-name:focus {
      border-color: var(--accent-1);
    }

    .settings-preset-save {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      font-weight: 600;
      font-family: inherit;
      color: var(--ink);
      background-color: var(--accent-1);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      white-space: nowrap;
    }

    .settings-preset-save:hover {
      background-color: var(--accent-1-hover);
    }

    .settings-preset-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .settings-preset-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.25rem 0.6rem;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--ink);
      background-color: var(--primary-100);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .settings-preset-chip:hover {
      background-color: var(--paper);
    }

    .settings-preset-chip-delete {
      background: none;
      border: none;
      color: var(--primary-400);
      font-size: 0.9rem;
      line-height: 1;
      cursor: pointer;
      padding: 0;
    }

    .settings-preset-chip-delete:hover {
      color: var(--accent-2);
    }

    .settings-divider {
      border: none;
      border-top: 1px solid var(--primary-300);
      margin: 0.3rem 0;
    }

    .settings-share-btn {
      padding: 0.5rem 1.2rem;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: inherit;
      color: var(--paper);
      background-color: var(--primary-300);
      border: none;
      border-radius: 40px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.15s ease;
      align-self: center;
    }

    .settings-share-btn:hover {
      background-color: var(--accent-1);
      color: var(--ink);
      transform: scale(1.04);
    }

    .settings-share-btn:active {
      transform: scale(0.97);
    }

    .settings-share-btn:focus-visible {
      outline: 2px solid var(--paper);
      outline-offset: 2px;
    }
  </style>
</head>
<body>

  <!-- Settings gear button (visible on landing only) -->
  <button class="settings-btn" id="settings-btn" aria-label="Settings">&#9881;</button>

  <!-- Settings overlay -->
  <div class="settings-overlay" id="settings-overlay">
    <div class="settings-panel">
      <div class="settings-title">Settings</div>
      <div class="settings-field">
        <label for="settings-title-input">App Title</label>
        <input type="text" id="settings-title-input" placeholder="Idea Spinner">
      </div>

      <hr class="settings-divider">

      <!-- People Prompts -->
      <div class="settings-section-title">People Prompts</div>
      <div class="settings-helper">These prompts help participants think of someone in their community.</div>
      <div class="settings-prompt-list" id="settings-name-prompts"></div>
      <button class="settings-add-btn" id="settings-name-add">+ Add prompt</button>
      <button class="settings-reset-btn" id="settings-name-reset">Reset to defaults</button>

      <hr class="settings-divider">

      <!-- Idea Prompts -->
      <div class="settings-section-title">Idea Prompts</div>
      <div class="settings-helper">Use [NAME] as a placeholder — it gets replaced with the participant's name.</div>
      <div class="settings-prompt-list" id="settings-idea-prompts"></div>
      <button class="settings-add-btn" id="settings-idea-add">+ Add prompt</button>
      <button class="settings-reset-btn" id="settings-idea-reset">Reset to defaults</button>

      <hr class="settings-divider">

      <!-- Theme -->
      <div class="settings-section-title">Theme</div>
      <div class="settings-color-row">
        <span class="settings-color-label">Background</span>
        <input type="color" class="settings-color-swatch" id="theme-bg-swatch">
        <input type="text" class="settings-color-hex" id="theme-bg-hex" placeholder="#224749">
      </div>
      <div class="settings-color-row">
        <span class="settings-color-label">Text / Paper</span>
        <input type="color" class="settings-color-swatch" id="theme-paper-swatch">
        <input type="text" class="settings-color-hex" id="theme-paper-hex" placeholder="#FAF4DD">
      </div>
      <div class="settings-color-row">
        <span class="settings-color-label">Accent</span>
        <input type="color" class="settings-color-swatch" id="theme-accent-swatch">
        <input type="text" class="settings-color-hex" id="theme-accent-hex" placeholder="#A67C52">
      </div>
      <div class="settings-color-row">
        <span class="settings-color-label">Button</span>
        <input type="color" class="settings-color-swatch" id="theme-button-swatch">
        <input type="text" class="settings-color-hex" id="theme-button-hex" placeholder="#6E744F">
      </div>
      <div class="settings-preset-row">
        <input type="text" class="settings-preset-name" id="theme-preset-name" placeholder="Preset name...">
        <button class="settings-preset-save" id="theme-preset-save">Save</button>
      </div>
      <div class="settings-preset-chips" id="theme-preset-chips"></div>
      <button class="settings-reset-btn" id="theme-reset">Reset to default</button>

      <hr class="settings-divider">

      <button class="settings-share-btn" id="settings-share-btn">Copy Share Link</button>

      <button class="settings-done-btn" id="settings-done-btn">Done</button>
    </div>
  </div>

  <!-- Start Over button (visible on all screens except landing) -->
  <button class="start-over" id="start-over-btn">&#8592; Start Over</button>

  <!-- Floating proposal counter -->
  <button class="proposal-indicator" id="proposal-indicator">
    <span id="proposal-indicator-count">0</span> &#128203;
  </button>

  <!-- Toast notification -->
  <div class="toast" id="toast"></div>

  <!-- ===== Review Screen ===== -->
  <div class="screen" id="review-screen">
    <div class="review-header">
      <span class="review-title">Proposals</span>
      <span class="review-count" id="review-count"></span>
    </div>
    <div class="select-all-row">
      <input type="checkbox" id="select-all-check">
      <label for="select-all-check" id="select-all-label">Select all</label>
    </div>
    <div class="review-list" id="review-list"></div>
    <div class="email-row">
      <label for="email-input">Email to:</label>
      <input type="email" class="email-input" id="email-input" placeholder="recipient@example.com">
    </div>
    <div class="export-toolbar">
      <button class="export-btn" id="export-copy" disabled>Copy</button>
      <button class="export-btn" id="export-email" disabled>Email</button>
      <button class="export-btn" id="export-csv" disabled>CSV</button>
      <button class="export-btn" id="export-json" disabled>Decidim JSON</button>
    </div>
    <button class="back-btn" id="review-back-btn">&#8592; Back</button>
  </div>

  <!-- ===== Landing Screen ===== -->
  <div class="screen active" id="landing">
    <h1>Idea Spinner</h1>
    <p class="tagline">Dream up ideas for your community's budget</p>
    <button class="btn pulse" id="start-btn">Let's Go!</button>
  </div>

  <!-- ===== Name Prompts Screen ===== -->
  <div class="screen" id="names-screen">
    <div class="step-dots" id="step-dots-names"></div>
    <p class="step-label" id="name-step-label">Think of someone...</p>
    <div class="prompt-box">
      <p class="prompt-text" id="name-prompt-text"></p>
    </div>
    <button class="shuffle-btn" id="shuffle-btn-names">&#127922; Different prompt</button>
    <input
      type="text"
      class="name-input"
      id="name-input"
      placeholder="First name"
      autocomplete="off"
    >
    <div class="button-row" id="name-buttons"></div>
    <div class="name-chips" id="name-chips"></div>
  </div>

  <!-- ===== Spinner Screen ===== -->
  <div class="screen" id="spinner-screen">
    <div class="step-dots" id="step-dots-spinner"></div>
    <p class="step-label">What comes to mind?</p>
    <button class="shuffle-btn" id="spin-btn">&#127922; Spin again</button>
    <div class="spinner-prompt-box">
      <p class="spinner-prompt" id="spinner-prompt"></p>
    </div>
    <textarea
      class="spinner-answer"
      id="spinner-answer"
      placeholder="Your answer..."
    ></textarea>
    <div class="button-row">
      <button class="btn" id="have-idea-btn">Turn This Into a Proposal</button>
    </div>
  </div>

  <!-- ===== Proposal Screen ===== -->
  <div class="screen" id="proposal-screen">
    <div class="step-dots" id="step-dots-proposal"></div>
    <div class="proposal-banner" id="proposal-banner"></div>
    <div class="inspiration-card" id="inspiration-card">
      <div class="inspiration-label">Your inspiration</div>
      <div class="inspiration-prompt" id="inspiration-prompt"></div>
      <div class="inspiration-answer" id="inspiration-answer"></div>
    </div>
    <div class="proposal-form">
      <div class="field-group">
        <label class="field-label" for="proposal-title">Title</label>
        <input type="text" class="field-input" id="proposal-title" placeholder="Give your idea a name">
      </div>
      <div class="field-group">
        <label class="field-label" for="proposal-money">What would we do with the money?</label>
        <textarea class="field-input" id="proposal-money" placeholder="Describe how the funds would be used"></textarea>
      </div>
      <div class="field-group">
        <label class="field-label" for="proposal-why">Why is this needed?</label>
        <textarea class="field-input" id="proposal-why" placeholder="Why does this matter for the community?"></textarea>
      </div>
    </div>
    <div class="button-row">
      <button class="btn" id="save-proposal-btn">Save Proposal</button>
      <button class="btn-secondary" id="spin-more-btn">Spin More Ideas</button>
    </div>
  </div>

  <!-- ===== Thank You Screen ===== -->
  <div class="screen" id="thankyou-screen">
    <div class="step-dots" id="step-dots-thankyou"></div>
    <p class="thankyou-title">Nice one!</p>
    <p class="thankyou-subtitle">Your proposal has been saved.</p>
    <span class="proposal-count-badge" id="proposal-count-badge"></span>
    <div class="button-row">
      <button class="btn" id="spin-more-from-thankyou">Spin More Ideas</button>
      <button class="btn-secondary" id="next-person-btn">Start Over</button>
    </div>
  </div>

  <script>
    // ---- App State ----
    const state = {
      names: [],
      currentSpinName: '',
      currentSpinPrompt: '',
      proposals: [],
      previousScreen: 'landing',
      usedNamePrompts: [],
      usedIdeaPrompts: []
    };

    const MAX_NAMES = 5;
    const MIN_NAMES_BEFORE_SKIP = 2;
    const APP_STEPS = ['names', 'spinner', 'proposal'];

    // ---- Name Prompts Pool ----
    const NAME_PROMPTS = [
      "A friend or neighbor who is between jobs right now",
      "Someone you know who has trouble getting around the city",
      "A young person in your life who could use more opportunities",
      "Someone in your community who is raising kids on their own",
      "An older person you know who deserves better support",
      "Someone who has had trouble finding affordable housing",
      "A person you know who struggles to access healthcare",
      "Someone in your neighborhood who could use a safer place to hang out",
      "A friend who has a hard time affording groceries",
      "Someone you know who would benefit from job training or classes",
      "A person in your life who has trouble accessing childcare",
      "Someone who relies on public services that could be better"
    ];

    // ---- Idea Prompts Pool ----
    const IDEA_PROMPTS = [
      "What is something [NAME] uses every day that needs to be fixed?",
      "What would make [NAME]'s neighborhood feel safer?",
      "What service would make [NAME]'s life a little easier?",
      "If [NAME] had one wish for their community, what would it be?",
      "What is something [NAME] needs but can't easily get to?",
      "What would help [NAME] get to where they need to go?",
      "What kind of program would help someone like [NAME] get ahead?",
      "What public space could be improved for people like [NAME]?",
      "What is one thing the city could do to help [NAME] right now?",
      "What would make [NAME]'s daily routine less stressful?",
      "What does [NAME] deserve that the community doesn't offer yet?",
      "If you could build one thing for [NAME], what would it be?"
    ];

    const STEP_LABELS = [
      "Think of someone...",
      "Think of someone else...",
      "Anyone else come to mind?",
      "Keep going...",
      "Last one!"
    ];

    // ---- Settings ----
    var DEFAULT_THEME = { bg: '#224749', paper: '#FAF4DD', accent: '#A67C52', button: '#6E744F' };

    function getSettings() {
      try {
        return JSON.parse(localStorage.getItem('ideaspinner-settings')) || {};
      } catch (e) {
        return {};
      }
    }

    function saveSettingsObj(obj) {
      localStorage.setItem('ideaspinner-settings', JSON.stringify(obj));
    }

    function getNamePrompts() {
      return getSettings().namePrompts || NAME_PROMPTS;
    }

    function getIdeaPrompts() {
      return getSettings().ideaPrompts || IDEA_PROMPTS;
    }

    // --- Color helpers ---
    function hexToHSL(hex) {
      hex = hex.replace('#', '');
      var r = parseInt(hex.substring(0, 2), 16) / 255;
      var g = parseInt(hex.substring(2, 4), 16) / 255;
      var b = parseInt(hex.substring(4, 6), 16) / 255;
      var max = Math.max(r, g, b), min = Math.min(r, g, b);
      var h = 0, s = 0, l = (max + min) / 2;
      if (max !== min) {
        var d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        if (max === r) h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
        else if (max === g) h = ((b - r) / d + 2) / 6;
        else h = ((r - g) / d + 4) / 6;
      }
      return [h * 360, s * 100, l * 100];
    }

    function hslToHex(h, s, l) {
      h /= 360; s /= 100; l /= 100;
      var r, g, b;
      if (s === 0) { r = g = b = l; } else {
        function hue2rgb(p, q, t) {
          if (t < 0) t += 1; if (t > 1) t -= 1;
          if (t < 1/6) return p + (q - p) * 6 * t;
          if (t < 1/2) return q;
          if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
        }
        var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        var p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
      }
      function toHex(c) { var v = Math.round(c * 255).toString(16); return v.length === 1 ? '0' + v : v; }
      return '#' + toHex(r) + toHex(g) + toHex(b);
    }

    function adjustLightness(hex, amount) {
      var hsl = hexToHSL(hex);
      hsl[2] = Math.max(0, Math.min(100, hsl[2] + amount));
      return hslToHex(hsl[0], hsl[1], hsl[2]);
    }

    function desaturate(hex, amount) {
      var hsl = hexToHSL(hex);
      hsl[1] = Math.max(0, Math.min(100, hsl[1] - amount));
      hsl[2] = Math.max(0, Math.min(100, hsl[2] + 30));
      return hslToHex(hsl[0], hsl[1], hsl[2]);
    }

    function luminance(hex) {
      hex = hex.replace('#', '');
      var r = parseInt(hex.substring(0, 2), 16) / 255;
      var g = parseInt(hex.substring(2, 4), 16) / 255;
      var b = parseInt(hex.substring(4, 6), 16) / 255;
      return 0.299 * r + 0.587 * g + 0.114 * b;
    }

    function isValidHex(v) {
      return /^#[0-9a-fA-F]{6}$/.test(v);
    }

    // --- Theme application ---
    function applyTheme(theme) {
      var root = document.documentElement.style;
      if (!theme) {
        // Reset to CSS defaults
        var props = ['--primary-500','--primary-700','--primary-400','--primary-300','--primary-100',
          '--paper','--stone','--accent-1','--accent-1-hover','--accent-2','--accent-2-hover','--accent-2-active',
          '--olive-deep','--olive-hover','--olive-active','--ink','--secondary','--hover-teal','--active-teal'];
        props.forEach(function(p) { root.removeProperty(p); });
        return;
      }
      var bg = theme.bg || DEFAULT_THEME.bg;
      var paper = theme.paper || DEFAULT_THEME.paper;
      var accent = theme.accent || DEFAULT_THEME.accent;
      var button = theme.button || DEFAULT_THEME.button;

      root.setProperty('--primary-500', bg);
      root.setProperty('--primary-700', adjustLightness(bg, -10));
      root.setProperty('--primary-400', adjustLightness(bg, 6));
      root.setProperty('--primary-300', adjustLightness(bg, 12));
      root.setProperty('--primary-100', desaturate(bg, 30));
      root.setProperty('--hover-teal', adjustLightness(bg, -5));
      root.setProperty('--active-teal', adjustLightness(bg, -10));
      root.setProperty('--paper', paper);
      root.setProperty('--stone', adjustLightness(paper, -5));
      root.setProperty('--accent-1', accent);
      root.setProperty('--accent-1-hover', adjustLightness(accent, 8));
      root.setProperty('--accent-2', adjustLightness(accent, -10));
      root.setProperty('--accent-2-hover', adjustLightness(accent, -5));
      root.setProperty('--accent-2-active', adjustLightness(accent, -15));
      root.setProperty('--olive-deep', button);
      root.setProperty('--olive-hover', adjustLightness(button, 8));
      root.setProperty('--olive-active', adjustLightness(button, -5));
      root.setProperty('--secondary', adjustLightness(button, 15));
      root.setProperty('--ink', luminance(paper) > 0.5 ? '#282413' : '#f5f0e0');
    }

    function getTheme() {
      return getSettings().theme || null;
    }

    function getSavedThemes() {
      return getSettings().savedThemes || [];
    }

    // --- Prompt editor (generic) ---
    function renderPromptEditor(containerId, prompts) {
      var container = document.getElementById(containerId);
      container.innerHTML = '';
      prompts.forEach(function(text) {
        addPromptRow(container, text);
      });
    }

    function addPromptRow(container, text) {
      var row = document.createElement('div');
      row.className = 'settings-prompt-row';
      var input = document.createElement('input');
      input.type = 'text';
      input.className = 'settings-prompt-input';
      input.value = text || '';
      row.appendChild(input);
      var del = document.createElement('button');
      del.type = 'button';
      del.className = 'settings-prompt-delete';
      del.innerHTML = '&times;';
      del.addEventListener('click', function() { row.remove(); });
      row.appendChild(del);
      container.appendChild(row);
      return input;
    }

    function readPromptEditor(containerId) {
      var inputs = document.querySelectorAll('#' + containerId + ' .settings-prompt-input');
      var result = [];
      inputs.forEach(function(inp) {
        var v = inp.value.trim();
        if (v) result.push(v);
      });
      return result;
    }

    function arraysEqual(a, b) {
      if (a.length !== b.length) return false;
      for (var i = 0; i < a.length; i++) { if (a[i] !== b[i]) return false; }
      return true;
    }

    // --- Theme color inputs sync ---
    function syncColorInputs(swatchId, hexId) {
      var swatch = document.getElementById(swatchId);
      var hex = document.getElementById(hexId);
      swatch.addEventListener('input', function() {
        hex.value = swatch.value;
        livePreviewTheme();
      });
      hex.addEventListener('input', function() {
        var v = hex.value.trim();
        if (!v.startsWith('#')) v = '#' + v;
        if (isValidHex(v)) {
          swatch.value = v;
          livePreviewTheme();
        }
      });
    }

    function getThemeFromInputs() {
      return {
        bg: document.getElementById('theme-bg-swatch').value,
        paper: document.getElementById('theme-paper-swatch').value,
        accent: document.getElementById('theme-accent-swatch').value,
        button: document.getElementById('theme-button-swatch').value
      };
    }

    function setThemeInputs(theme) {
      var t = theme || DEFAULT_THEME;
      document.getElementById('theme-bg-swatch').value = t.bg;
      document.getElementById('theme-bg-hex').value = t.bg;
      document.getElementById('theme-paper-swatch').value = t.paper;
      document.getElementById('theme-paper-hex').value = t.paper;
      document.getElementById('theme-accent-swatch').value = t.accent;
      document.getElementById('theme-accent-hex').value = t.accent;
      document.getElementById('theme-button-swatch').value = t.button;
      document.getElementById('theme-button-hex').value = t.button;
    }

    function livePreviewTheme() {
      applyTheme(getThemeFromInputs());
    }

    function themeEquals(a, b) {
      return a.bg === b.bg && a.paper === b.paper && a.accent === b.accent && a.button === b.button;
    }

    // --- Preset chips ---
    function renderPresetChips() {
      var container = document.getElementById('theme-preset-chips');
      container.innerHTML = '';
      var presets = getSavedThemes();
      presets.forEach(function(preset, i) {
        var chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'settings-preset-chip';
        chip.textContent = preset.name;
        chip.addEventListener('click', function() {
          setThemeInputs(preset);
          livePreviewTheme();
        });
        var del = document.createElement('button');
        del.type = 'button';
        del.className = 'settings-preset-chip-delete';
        del.innerHTML = '&times;';
        del.addEventListener('click', function(e) {
          e.stopPropagation();
          var settings = getSettings();
          settings.savedThemes = (settings.savedThemes || []).filter(function(_, idx) { return idx !== i; });
          if (settings.savedThemes.length === 0) delete settings.savedThemes;
          saveSettingsObj(settings);
          renderPresetChips();
        });
        chip.appendChild(del);
        container.appendChild(chip);
      });
    }

    // --- Open / Close settings ---
    function applySettings() {
      var settings = getSettings();
      var title = settings.title || 'Idea Spinner';
      document.querySelector('#landing h1').textContent = title;
      document.title = title;
      applyTheme(getTheme());
    }

    function openSettings() {
      var settings = getSettings();
      // Title
      document.getElementById('settings-title-input').value = settings.title || '';
      // Prompt editors
      renderPromptEditor('settings-name-prompts', getNamePrompts());
      renderPromptEditor('settings-idea-prompts', getIdeaPrompts());
      // Theme
      setThemeInputs(getTheme());
      renderPresetChips();
      document.getElementById('theme-preset-name').value = '';
      // Show
      document.getElementById('settings-overlay').classList.add('visible');
      document.getElementById('settings-title-input').focus();
    }

    function closeSettings() {
      var settings = getSettings();

      // Title
      var titleVal = document.getElementById('settings-title-input').value.trim();
      if (titleVal) { settings.title = titleVal; } else { delete settings.title; }

      // Name prompts
      var namePrompts = readPromptEditor('settings-name-prompts');
      if (namePrompts.length > 0 && !arraysEqual(namePrompts, NAME_PROMPTS)) {
        settings.namePrompts = namePrompts;
      } else {
        delete settings.namePrompts;
      }

      // Idea prompts
      var ideaPrompts = readPromptEditor('settings-idea-prompts');
      if (ideaPrompts.length > 0 && !arraysEqual(ideaPrompts, IDEA_PROMPTS)) {
        settings.ideaPrompts = ideaPrompts;
      } else {
        delete settings.ideaPrompts;
      }

      // Theme
      var theme = getThemeFromInputs();
      if (!themeEquals(theme, DEFAULT_THEME)) {
        settings.theme = theme;
      } else {
        delete settings.theme;
      }

      saveSettingsObj(settings);
      applySettings();
      // Reset used prompt trackers so new prompts take effect
      state.usedNamePrompts = [];
      state.usedIdeaPrompts = [];
      document.getElementById('settings-overlay').classList.remove('visible');
    }

    document.getElementById('settings-btn').addEventListener('click', openSettings);
    document.getElementById('settings-done-btn').addEventListener('click', closeSettings);

    // Prompt editor add buttons
    document.getElementById('settings-name-add').addEventListener('click', function() {
      var inp = addPromptRow(document.getElementById('settings-name-prompts'), '');
      inp.focus();
    });
    document.getElementById('settings-idea-add').addEventListener('click', function() {
      var inp = addPromptRow(document.getElementById('settings-idea-prompts'), '');
      inp.focus();
    });

    // Prompt editor reset buttons
    document.getElementById('settings-name-reset').addEventListener('click', function() {
      renderPromptEditor('settings-name-prompts', NAME_PROMPTS);
    });
    document.getElementById('settings-idea-reset').addEventListener('click', function() {
      renderPromptEditor('settings-idea-prompts', IDEA_PROMPTS);
    });

    // Color input sync
    syncColorInputs('theme-bg-swatch', 'theme-bg-hex');
    syncColorInputs('theme-paper-swatch', 'theme-paper-hex');
    syncColorInputs('theme-accent-swatch', 'theme-accent-hex');
    syncColorInputs('theme-button-swatch', 'theme-button-hex');

    // Theme reset
    document.getElementById('theme-reset').addEventListener('click', function() {
      setThemeInputs(DEFAULT_THEME);
      livePreviewTheme();
    });

    // Save preset
    document.getElementById('theme-preset-save').addEventListener('click', function() {
      var name = document.getElementById('theme-preset-name').value.trim();
      if (!name) {
        document.getElementById('theme-preset-name').focus();
        return;
      }
      var theme = getThemeFromInputs();
      var settings = getSettings();
      if (!settings.savedThemes) settings.savedThemes = [];
      settings.savedThemes.push({ name: name, bg: theme.bg, paper: theme.paper, accent: theme.accent, button: theme.button });
      saveSettingsObj(settings);
      document.getElementById('theme-preset-name').value = '';
      renderPresetChips();
    });

    // ---- Helpers ----
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(id);
      screen.classList.add('active');
      screen.classList.remove('fade-in');
      void screen.offsetWidth;
      screen.classList.add('fade-in');

      // Show/hide the Start Over button (hidden on landing and review)
      const startOverBtn = document.getElementById('start-over-btn');
      if (id === 'landing' || id === 'review-screen') {
        startOverBtn.classList.remove('visible');
      } else {
        startOverBtn.classList.add('visible');
      }

      // Show gear icon only on landing
      const settingsBtn = document.getElementById('settings-btn');
      if (id === 'landing') {
        settingsBtn.classList.add('visible');
      } else {
        settingsBtn.classList.remove('visible');
      }

      renderProposalIndicator();
    }

    function resetForNewParticipant() {
      state.names = [];
      state.currentSpinName = '';
      state.currentSpinPrompt = '';
      state.usedNamePrompts = [];
      state.usedIdeaPrompts = [];
      // proposals are kept — they belong to the whole session
      showScreen('landing');
    }

    function renderStepDots(containerId, currentStep) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const currentIdx = APP_STEPS.indexOf(currentStep);
      APP_STEPS.forEach((step, i) => {
        const dot = document.createElement('span');
        dot.className = 'step-dot';
        if (i < currentIdx) dot.classList.add('filled');
        if (i === currentIdx) dot.classList.add('current');
        container.appendChild(dot);
      });
    }

    function pickFromPool(pool, usedList) {
      const available = pool
        .map((_, i) => i)
        .filter(i => !usedList.includes(i));
      if (available.length === 0) {
        usedList.length = 0;
        return pickFromPool(pool, usedList);
      }
      const pick = available[Math.floor(Math.random() * available.length)];
      usedList.push(pick);
      return pool[pick];
    }

    function pickRandomName() {
      return state.names[Math.floor(Math.random() * state.names.length)];
    }

    // Build prompt HTML with name as highlighted variable
    function renderSpinnerPrompt(raw, name) {
      const promptEl = document.getElementById('spinner-prompt');
      promptEl.innerHTML = '';
      const parts = raw.split('[NAME]');
      parts.forEach((part, i) => {
        promptEl.appendChild(document.createTextNode(part));
        if (i < parts.length - 1) {
          const nameSpan = document.createElement('span');
          nameSpan.className = 'name-variable';
          nameSpan.textContent = name;
          promptEl.appendChild(nameSpan);
        }
      });
      promptEl.classList.remove('prompt-fade');
      void promptEl.offsetWidth;
      promptEl.classList.add('prompt-fade');
    }

    // ========================================
    //  PROPOSAL INDICATOR + REVIEW SCREEN
    // ========================================

    function renderProposalIndicator() {
      const indicator = document.getElementById('proposal-indicator');
      const countEl = document.getElementById('proposal-indicator-count');
      const count = state.proposals.length;
      if (count > 0) {
        countEl.textContent = count;
        indicator.classList.add('visible');
      } else {
        indicator.classList.remove('visible');
      }
    }

    function goToReview() {
      // Remember which screen we came from
      const current = document.querySelector('.screen.active');
      if (current) {
        state.previousScreen = current.id;
      }
      showScreen('review-screen');
      renderReviewCards();
    }

    function renderReviewCards() {
      const list = document.getElementById('review-list');
      const countEl = document.getElementById('review-count');
      list.innerHTML = '';
      countEl.textContent = state.proposals.length;

      // Pre-fill email from localStorage
      const emailInput = document.getElementById('email-input');
      const savedEmail = localStorage.getItem('ideaspinner-email');
      if (savedEmail && !emailInput.value) emailInput.value = savedEmail;

      state.proposals.forEach(function (p, i) {
        const wrap = document.createElement('div');
        wrap.className = 'review-card-wrap';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'review-card-check';
        checkbox.dataset.index = i;
        checkbox.checked = true;
        checkbox.addEventListener('change', updateExportState);
        wrap.appendChild(checkbox);

        const card = document.createElement('div');
        card.className = 'review-card';

        const title = document.createElement('div');
        title.className = 'review-card-title';
        title.textContent = p.title;
        card.appendChild(title);

        const nameRow = document.createElement('div');
        nameRow.className = 'review-card-name';
        nameRow.innerHTML = 'Designed for people like <span class="name-variable">' +
          p.name.replace(/</g, '&lt;') + '</span>';
        card.appendChild(nameRow);

        if (p.money) {
          const money = document.createElement('div');
          money.className = 'review-card-detail';
          money.innerHTML = '<span class="review-card-detail-label">What would we do with the money?</span> ' +
            p.money.replace(/</g, '&lt;');
          card.appendChild(money);
        }

        if (p.why) {
          const why = document.createElement('div');
          why.className = 'review-card-detail';
          why.innerHTML = '<span class="review-card-detail-label">Why is this needed?</span> ' +
            p.why.replace(/</g, '&lt;');
          card.appendChild(why);
        }

        wrap.appendChild(card);
        list.appendChild(wrap);
      });

      // Set select-all to checked initially
      document.getElementById('select-all-check').checked = true;
      updateExportState();
    }

    // ========================================
    //  EXPORT HELPERS
    // ========================================

    function getSelectedProposals() {
      const checks = document.querySelectorAll('.review-card-check');
      var selected = [];
      checks.forEach(function (cb) {
        if (cb.checked) selected.push(state.proposals[parseInt(cb.dataset.index)]);
      });
      return selected;
    }

    function updateExportState() {
      var selected = getSelectedProposals();
      var hasSelection = selected.length > 0;
      document.getElementById('export-copy').disabled = !hasSelection;
      document.getElementById('export-email').disabled = !hasSelection;
      document.getElementById('export-csv').disabled = !hasSelection;
      document.getElementById('export-json').disabled = !hasSelection;

      // Update select-all checkbox state
      var allChecks = document.querySelectorAll('.review-card-check');
      var allChecked = allChecks.length > 0 && selected.length === allChecks.length;
      var selectAllEl = document.getElementById('select-all-check');
      selectAllEl.checked = allChecked;
      selectAllEl.indeterminate = selected.length > 0 && !allChecked;
      document.getElementById('select-all-label').textContent =
        allChecked ? 'Deselect all' : 'Select all';
    }

    // Select all / deselect all
    document.getElementById('select-all-check').addEventListener('change', function () {
      var checked = this.checked;
      document.querySelectorAll('.review-card-check').forEach(function (cb) {
        cb.checked = checked;
      });
      updateExportState();
    });

    function formatProposalBody(p) {
      var parts = [];
      if (p.money) parts.push(p.money);
      if (p.why) parts.push(p.why);
      return parts.join('\n\n');
    }

    function formatAsPlainText(proposals) {
      return proposals.map(function (p) {
        return 'Title: ' + p.title +
          '\n\n' + formatProposalBody(p);
      }).join('\n\n---\n\n');
    }

    function showToast(message) {
      var toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(function () { toast.classList.remove('visible'); }, 2000);
    }

    function csvEscape(val) {
      if (/[",\n\r]/.test(val)) return '"' + val.replace(/"/g, '""') + '"';
      return val;
    }

    function downloadBlob(blob, filename) {
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Copy to clipboard ---
    document.getElementById('export-copy').addEventListener('click', function () {
      var selected = getSelectedProposals();
      if (!selected.length) return;
      var text = formatAsPlainText(selected);
      navigator.clipboard.writeText(text).then(function () {
        showToast('Copied!');
      }, function () {
        showToast('Copy failed — try again');
      });
    });

    // --- Email ---
    document.getElementById('export-email').addEventListener('click', function () {
      var selected = getSelectedProposals();
      if (!selected.length) return;
      var emailInput = document.getElementById('email-input');
      var recipient = emailInput.value.trim();
      // Save for next session
      if (recipient) localStorage.setItem('ideaspinner-email', recipient);

      var subject = encodeURIComponent('Idea Spinner Proposals');
      var intro = 'Here are the proposals from our Idea Spinner session:\n\n';
      var body = encodeURIComponent(intro + formatAsPlainText(selected));
      window.location.href = 'mailto:' + encodeURIComponent(recipient) +
        '?subject=' + subject + '&body=' + body;
    });

    // --- CSV ---
    document.getElementById('export-csv').addEventListener('click', function () {
      var selected = getSelectedProposals();
      if (!selected.length) return;
      var rows = ['Title,Description'];
      selected.forEach(function (p) {
        rows.push(
          csvEscape(p.title) + ',' +
          csvEscape(formatProposalBody(p))
        );
      });
      var blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8' });
      downloadBlob(blob, 'idea-spinner-proposals.csv');
    });

    // --- Decidim JSON ---
    document.getElementById('export-json').addEventListener('click', function () {
      var selected = getSelectedProposals();
      if (!selected.length) return;
      var data = selected.map(function (p) {
        return {
          'title/en': p.title,
          'body/en': formatProposalBody(p),
          'scope/id': '',
          'category/id': ''
        };
      });
      var json = JSON.stringify(data, null, 2);
      var blob = new Blob([json], { type: 'application/json;charset=utf-8' });
      downloadBlob(blob, 'idea-spinner-decidim.json');
    });

    // --- Save email on input ---
    document.getElementById('email-input').addEventListener('change', function () {
      var val = this.value.trim();
      if (val) localStorage.setItem('ideaspinner-email', val);
    });

    document.getElementById('proposal-indicator').addEventListener('click', function () {
      const current = document.querySelector('.screen.active');
      if (current && current.id === 'review-screen') return;
      goToReview();
    });

    document.getElementById('review-back-btn').addEventListener('click', function () {
      showScreen(state.previousScreen);
    });

    // ========================================
    //  NAMES SCREEN
    // ========================================

    function renderNameChips() {
      const container = document.getElementById('name-chips');
      container.innerHTML = '';
      state.names.forEach((name, i) => {
        const chip = document.createElement('span');
        chip.className = 'name-chip';
        chip.textContent = name;

        const removeBtn = document.createElement('button');
        removeBtn.className = 'name-chip-remove';
        removeBtn.innerHTML = '&times;';
        removeBtn.setAttribute('aria-label', 'Remove ' + name);
        removeBtn.addEventListener('click', () => {
          state.names.splice(i, 1);
          if (state.names.length < MIN_NAMES_BEFORE_SKIP) {
            showNamePrompt();
          } else {
            renderNameChips();
            rebuildNameButtons();
          }
        });
        chip.appendChild(removeBtn);
        container.appendChild(chip);
      });
    }

    function showNamePrompt() {
      // Ensure prompt area is visible (may be hidden by showReadyToSpin)
      document.getElementById('name-input').style.display = '';
      document.getElementById('name-prompt-text').parentElement.style.display = '';
      document.getElementById('shuffle-btn-names').style.display = '';

      const nameCount = state.names.length;
      const labelIdx = Math.min(nameCount, STEP_LABELS.length - 1);
      document.getElementById('name-step-label').textContent = STEP_LABELS[labelIdx];

      const promptText = pickFromPool(getNamePrompts(), state.usedNamePrompts);
      const promptEl = document.getElementById('name-prompt-text');
      promptEl.textContent = promptText;
      promptEl.classList.remove('prompt-fade');
      void promptEl.offsetWidth;
      promptEl.classList.add('prompt-fade');

      document.getElementById('name-input').value = '';
      document.getElementById('name-input').focus();

      renderStepDots('step-dots-names', 'names');
      renderNameChips();
      rebuildNameButtons();
    }

    function rebuildNameButtons() {
      const row = document.getElementById('name-buttons');
      row.innerHTML = '';
      const inputVisible = document.getElementById('name-input').style.display !== 'none';

      if (state.names.length >= MIN_NAMES_BEFORE_SKIP) {
        // "I'm Ready!" is always the primary action after 2 names
        const readyBtn = document.createElement('button');
        readyBtn.className = 'btn';
        readyBtn.textContent = "I'm Ready!";
        readyBtn.addEventListener('click', goToSpinner);
        row.appendChild(readyBtn);

        if (inputVisible && state.names.length < MAX_NAMES) {
          // Prompt is showing — provide an "Add" button to submit the name
          const addBtn = document.createElement('button');
          addBtn.className = 'btn-secondary';
          addBtn.textContent = state.names.length >= MAX_NAMES - 1 ? "Add & Finish" : "Add";
          addBtn.addEventListener('click', handleNameNext);
          row.appendChild(addBtn);
        } else if (!inputVisible && state.names.length < MAX_NAMES) {
          // Ready state — offer to add more
          const moreBtn = document.createElement('button');
          moreBtn.className = 'btn-secondary';
          moreBtn.textContent = 'Add more people';
          moreBtn.addEventListener('click', showNamePrompt);
          row.appendChild(moreBtn);
        }
      } else {
        // Fewer than 2 names — "Add" is the only action
        if (state.names.length < MAX_NAMES) {
          const nextBtn = document.createElement('button');
          nextBtn.className = 'btn';
          nextBtn.textContent = "Add";
          nextBtn.addEventListener('click', handleNameNext);
          row.appendChild(nextBtn);
        }
      }
    }

    function handleNameNext() {
      const input = document.getElementById('name-input');
      const name = input.value.trim();
      if (!name) {
        input.focus();
        input.style.borderColor = 'var(--accent-2)';
        setTimeout(() => { input.style.borderColor = 'transparent'; }, 800);
        return;
      }
      state.names.push(name);
      if (state.names.length >= MAX_NAMES) {
        goToSpinner();
        return;
      }
      if (state.names.length >= MIN_NAMES_BEFORE_SKIP) {
        showReadyToSpin();
        return;
      }
      showNamePrompt();
    }

    function showReadyToSpin() {
      document.getElementById('name-input').style.display = 'none';
      document.getElementById('name-prompt-text').parentElement.style.display = 'none';
      document.getElementById('shuffle-btn-names').style.display = 'none';
      document.getElementById('name-step-label').textContent = state.names.length + ' people added';
      renderStepDots('step-dots-names', 'names');
      renderNameChips();
      rebuildNameButtons();
    }

    document.getElementById('shuffle-btn-names').addEventListener('click', function () {
      const promptText = pickFromPool(getNamePrompts(), state.usedNamePrompts);
      const promptEl = document.getElementById('name-prompt-text');
      promptEl.textContent = promptText;
      promptEl.classList.remove('prompt-fade');
      void promptEl.offsetWidth;
      promptEl.classList.add('prompt-fade');
    });

    // ========================================
    //  SPINNER SCREEN
    // ========================================

    function goToSpinner() {
      showScreen('spinner-screen');
      spin();
    }

    function spin() {
      const name = pickRandomName();
      const raw = pickFromPool(getIdeaPrompts(), state.usedIdeaPrompts);

      state.currentSpinName = name;
      state.currentSpinPrompt = raw;

      renderSpinnerPrompt(raw, name);
      document.getElementById('spinner-answer').value = '';
      document.getElementById('spinner-answer').focus();
      renderStepDots('step-dots-spinner', 'spinner');
    }

    document.getElementById('spin-btn').addEventListener('click', spin);

    document.getElementById('have-idea-btn').addEventListener('click', function () {
      const answer = document.getElementById('spinner-answer').value.trim();
      const displayPrompt = state.currentSpinPrompt.replace(/\[NAME\]/g, state.currentSpinName);
      goToProposal(state.currentSpinName, displayPrompt, answer);
    });

    // ========================================
    //  PROPOSAL SCREEN
    // ========================================

    function goToProposal(name, prompt, answer) {
      showScreen('proposal-screen');

      // Banner
      const banner = document.getElementById('proposal-banner');
      banner.innerHTML = '';
      banner.appendChild(document.createTextNode('Designing for people like '));
      const nameSpan = document.createElement('span');
      nameSpan.className = 'name-variable';
      nameSpan.textContent = name;
      banner.appendChild(nameSpan);

      // Inspiration card
      const inspirationCard = document.getElementById('inspiration-card');
      const inspirationPrompt = document.getElementById('inspiration-prompt');
      const inspirationAnswer = document.getElementById('inspiration-answer');

      inspirationPrompt.textContent = prompt;

      if (answer) {
        inspirationAnswer.textContent = '"' + answer + '"';
        inspirationCard.style.display = '';
      } else {
        inspirationAnswer.textContent = '';
        // Still show the prompt they were looking at
        inspirationCard.style.display = '';
      }

      // Clear form
      document.getElementById('proposal-title').value = '';
      document.getElementById('proposal-money').value = '';
      document.getElementById('proposal-why').value = '';
      document.getElementById('proposal-title').focus();

      renderStepDots('step-dots-proposal', 'proposal');
    }

    document.getElementById('save-proposal-btn').addEventListener('click', function () {
      const title = document.getElementById('proposal-title').value.trim();
      const money = document.getElementById('proposal-money').value.trim();
      const why = document.getElementById('proposal-why').value.trim();

      if (!title) {
        const el = document.getElementById('proposal-title');
        el.focus();
        el.style.borderColor = 'var(--accent-2)';
        setTimeout(() => { el.style.borderColor = 'transparent'; }, 800);
        return;
      }

      state.proposals.push({
        name: state.currentSpinName,
        title,
        money,
        why
      });

      goToThankYou();
    });

    document.getElementById('spin-more-btn').addEventListener('click', function () {
      goToSpinner();
    });

    // ========================================
    //  THANK YOU SCREEN
    // ========================================

    function goToThankYou() {
      showScreen('thankyou-screen');
      const count = state.proposals.length;
      document.getElementById('proposal-count-badge').textContent =
        count + ' proposal' + (count === 1 ? '' : 's') + ' saved this session';
      renderStepDots('step-dots-thankyou', 'proposal');
      renderProposalIndicator();
    }

    document.getElementById('spin-more-from-thankyou').addEventListener('click', function () {
      goToSpinner();
    });

    document.getElementById('next-person-btn').addEventListener('click', function () {
      resetForNewParticipant();
    });

    // ========================================
    //  START OVER (any screen)
    // ========================================

    document.getElementById('start-over-btn').addEventListener('click', function () {
      resetForNewParticipant();
    });

    // ========================================
    //  LANDING
    // ========================================

    document.getElementById('start-btn').addEventListener('click', function () {
      showScreen('names-screen');
      showNamePrompt();
    });

    document.getElementById('name-input').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') handleNameNext();
    });

    // ---- Share / Import settings via URL ----
    document.getElementById('settings-share-btn').addEventListener('click', function() {
      // Save current form state first
      closeSettings();
      var settings = getSettings();
      // Only share if there's something custom
      var keys = Object.keys(settings);
      if (keys.length === 0) {
        showToast('Nothing to share — using defaults');
        openSettings();
        return;
      }
      var json = JSON.stringify(settings);
      var encoded = btoa(unescape(encodeURIComponent(json)));
      var base = window.location.href.split('?')[0].split('#')[0];
      var url = base + '?config=' + encoded;
      navigator.clipboard.writeText(url).then(function() {
        showToast('Share link copied!');
      }, function() {
        // Fallback: show URL in prompt
        prompt('Copy this share link:', url);
      });
    });

    function importSettingsFromURL() {
      var params = new URLSearchParams(window.location.search);
      var config = params.get('config');
      if (!config) return;
      try {
        var json = decodeURIComponent(escape(atob(config)));
        var imported = JSON.parse(json);
        if (typeof imported === 'object' && imported !== null) {
          saveSettingsObj(imported);
          // Clean the URL so it doesn't re-import on reload
          var cleanUrl = window.location.href.split('?')[0].split('#')[0];
          try { window.history.replaceState({}, '', cleanUrl); } catch(e) { /* file:// may block this */ }
        }
      } catch (e) {
        // Invalid config param — ignore silently
      }
    }

    // ---- Init ----
    importSettingsFromURL();
    applySettings();
    document.getElementById('settings-btn').classList.add('visible');
  </script>
</body>
</html>
